# CScan 数据模型

![untitled](https://user-images.githubusercontent.com/5803001/38597527-d9d4e4ba-3d8a-11e8-91f2-2959cf43c8da.png)

数据类型定义使用 TypeScript 语法。

| 属性名 | 数据类型 | 描述 | 可选值/默认值 |
| ------ | -------- | ---- | ------------- |


通用数据类型：

| 名字         | 说明                      |
| ------------ | ------------------------- |
| `_ID`        | 数据库内部自增主键        |
| `UUID`       | 唯一标识位，`varchar(40)` |
| `JSONArray`  | JSON 数组， `text`        |
| `JSONObject` | JSON 对象， `text`        |
| `IP`         | IP 格式， `varchar(16)`   |

约定：

* 尽量遵循 Single of Truth 原则，避免冗余数据的存在；对于统计查询类表，归档到 _统计报告_
  系列中，由定时器统计或者触发延时统计。
* 考虑到系统中存在着大量的数据联查统计，对于可能重复的字段名命名遵循 `{table_name}_{property_name}`
  原则，避免联查语句或者代码中的重命名（可能有扁平化操作）；对于不同表中表示相同含义的字段，应当保证命名的一致性。
* 保留字段名包括： `_id`, `create_time`, `update_time` 。
* 对于较长的前缀，做如下约定： `component -> c`, `vuln_type -> vt`,
  `asset_component -> ac`, `asset_vulns -> av` 。

## 数据类型定义 {#数据类型定义}

### 漏洞 {#漏洞}

漏洞类型

```typescript
enum VulnType {
  OTHER = 0, // 其他
  INJECTION = 1, // 注入
  XSS = 2, // xss跨站脚本攻击
  XXE = 3, // xml外部实体攻击
  FILE_UPLOAD = 4, // 任意文件上传
  FILE_OPERATION = 5, // 任意文件操作
  FILE_DOWNLOAD = 6, // 意文件下载
  FILE_TRAVERSAL = 7, // 目录遍历
  RCE = 8, // 远程命令/代码执行
  LFI = 9, // 本地文件包含
  RFI = 10, // 远程文件包含
  INFO_LEAK = 11, // 信息泄漏
  MISCONFIGURATION = 12 // 错误配置
}
```

漏洞危害级别

```typescript
enum VulnLevel {
  LOW = 1, // 低
  MED = 2, // 中
  HIGH = 3, // 高
  SEVERITY = 4 // 严重
}
```

## 安全漏洞 {#安全漏洞}

### component/组件 {#component-组件}

component 即表示可被攻击的目标，包括 CMS，操作系统，中间件，数据库，设备等。

| 属性名       | 数据类型       | 描述         | 可选值/默认值                                   |
| ------------ | -------------- | ------------ | ----------------------------------------------- |
| `_id`        | `_ID`          | 内部自增编号 |                                                 |
| `c_id`       | `UUID`         | 组件编号     |                                                 |
| `c_name`     | `varchar(10)`  | 组件名       |                                                 |
| `c_type`     | `enum`         | 组件类型     | `cms`, `os`, `middleware`, `database`, `device` |
| `desc`       | `text`         | 组件描述     |                                                 |
| `producer`   | `varchar(100)` | 生产商       |                                                 |
| `properties` | `text/json`    | 组件属性     |                                                 |

上表中，组件属性用 JSON 字符串格式存放，用于指明该组件的属性列表。系统本身对该属性在用户界面与 POC 之间进行透传，properties 的数据类型为 `ComponentProperties` ：

```typescript
interface ComponentProperty {
  name: string; // 属性名，使用点分方式命名，无需添加组件名
  display_name?: string; // 属性在用户界面的显示值，可选，空时，应默认显示 name 值
  type: 'string' | 'number'; // 指定该属性值的类型，例如端口是 "number"
}

// 组件属性列表，列表中应不存在重复属性名的属性
type ComponentPropertyList = ComponentProperty[];
```

实例数据：

```text
[
  {
    "name": "port",
    "display_name": "Mongodb 的端口",
    "type":"number"
  }
]
```

### vuln/漏洞 {#vuln-漏洞}

| 属性名            | 数据类型       | 描述                                  | 默认值/可选值 |
| ----------------- | -------------- | ------------------------------------- | ------------- |
| `_id`             | `_ID`          | 内部自增编号                          |               |
| `vuln_id`         | `UUID`         | 漏洞编号                              |               |
| `vuln_name`       | `varchar(100)` | 漏洞名称                              |               |
| `vuln_type`       | `int`          | 漏洞类型                              | `VulnType`    |
| `c_id`            | `UUID`         | 漏洞关联的组件编号                    |               |
| `c_version`       | `varchar(200)` | 漏洞关联的组件版本，JSON 数组形式存储 |               |
| `cve_id`          | `varchar(15)`  | 漏洞关联 CVE 编号                     |               |
| `disclosure_date` | `date`         | 发布时间                              |               |
| `submit_time`     | `date`         | 提交录入到平台时间                    |               |
| `level`           | `int`          | 漏洞等级                              | `VulnLevel`   |
| `source`          | `text`         | 漏洞参考来源                          |               |
| `detail`          | `text`         | 漏洞详情描述，HTML 格式               |               |
| `analysis`        | `text`         | 漏洞分析，PDF 路径地址                |               |

### poc/漏洞验证单元 {#poc-漏洞验证单元}

| 属性名        | 数据类型       | 描述                                | 默认值/可选值 |
| ------------- | -------------- | ----------------------------------- | ------------- |
| `_id`         | `_ID`          |                                     |               |
| `poc_id`      | `UUID`         | POC 编号                            |               |
| `poc_name`    | `varchar(20)`  | POC 名称，默认与漏洞名称一致        |               |
| `author`      | `varchar(50)`  | POC 作者名称                        |               |
| `create_time` | `date`         | POC 创建时间                        |               |
| `image_name`  | `varchar(200)` | POC 关联的镜像名称                  |               |
| `args`        | `text`         | 执行该 POC 时候所需要输入的特定参数 |               |

### vuln_poc_mappings/漏洞与 POC 关系映射 {#vuln_poc_mappings-漏洞与 POC 关系映射}

| 属性名    | 数据类型 | 描述     | 默认值/可选值 |
| --------- | -------- | -------- | ------------- |
| `_id`     | `_ID`    |          |               |
| `poc_id`  | `UUID`   | POC 编号 |               |
| `vuln_id` | `UUID`   | 漏洞编号 |               |

## 资产 {#资产}

### asset/资产 {#asset-资产}

| 属性名                 | 数据类型       | 描述                     | 默认值/可选值       |
| ---------------------- | -------------- | ------------------------ | ------------------- |
| `_id`                  | `_ID`          |                          |                     |
| `asset_id`             | `UUID`         | 资产编号                 |                     |
| `asset_name`           | `varchar(100)` | 资产名称                 | 必填                |
| `asset_ip`             | `IP`           | 资产 IP 地址             | 与域名二选一必填    |
| `asset_domain`         | `text`         | 域名                     |                     |
| `owner`                | `varchar(100)` | 责任人                   |                     |
| `owner_email`          | `varchar(100)` | 责任人邮箱               |                     |
| `asset_is_delete`      | `int`          | 是否删除                 | 0 - 未删除 1 - 删除 |
| `asset_vuln_nums`      | `int`          | 资产当前漏洞数           |                     |
| `asset_security_index` | `float`        | 资产当前安全指数         |                     |
| `last_scan_id`         | `UUID`         | 最后进行的安全扫描的编号 |                     |
| `create_time`          | `date`         | 创建时间                 |                     |

### asset_component/资产包含的组件 {#asset-component-资产包含的组件}

| 属性名          | 数据类型       | 描述                                   | 默认值/可选值 |
| --------------- | -------------- | -------------------------------------- | ------------- |
| `_id`           | `_ID`          |                                        |               |
| `asset_id`      | `UUID`         | 资产编号                               |               |
| `c_id`          | `UUID`         | 组件编号                               |               |
| `ac_desc`       | `varchar(100)` | 组件描述                               |               |
| `ac_properties` | `JSONObject`   | 组件属性，区别于 `c_properties` 元定义 |               |

### asset_vulns/资产的漏洞列表 {#asset-vulns-资产的漏洞列表}

记录每次扫描中发现的资产的漏洞情况。

| 属性名           | 数据类型                 | 描述                                    | 默认值/可选值 |
| ---------------- | ------------------------ | --------------------------------------- | ------------- |
| `_id`            | `_ID`                    |                                         |               |
| `av_id`          | `md5(asset_id + poc_id)` |                                         |               |
| `asset_id`       | `UUID`                   | 资产编号                                | 必填          |
| `c_id`           | `UUID`                   | 组件编号                                |               |
| `scan_id`        | `UUID`                   | 扫描编号                                |               |
| `task_id`        | `UUID`                   | 扫描对应的任务编号                      | 必填          |
| `poc_id`         | `UUID`                   | 扫描使用的 POC                          |               |
| `vuln_id`        | `UUID`                   | 扫描发现的漏洞编号                      |               |
| `is_false_alarm` | `int`                    | 是否为误报，0 - 非误报 1 - 误报，默认 0 |               |
| `create_time`    | `datetime`               | 记录创建时间                            |               |

## 任务扫描 {#任务扫描}

### scan/扫描 {#scan-扫描}

| 属性名                | 数据类型       | 描述                                                                      | 默认值/可选值                            |
| --------------------- | -------------- | ------------------------------------------------------------------------- | ---------------------------------------- |
| `_id`                 | `_ID`          |                                                                           |                                          |
| `scan_id`             | `UUID`         |                                                                           |                                          |
| `scan_name`           | `varchar(100)` | 扫描名称                                                                  |                                          |
| `asset_ids`           | `JSONArray`    | 扫描针对的资产编号列表                                                    |                                          |
| `poc_ids`             | `JSONArray`    | 扫描使用的 POC 列表                                                       |                                          |
| `task_nums`           | `int`          | 该扫描总任务数                                                            |                                          |
| `scan_status`         | `int`          | 扫描当前状态                                                              | 0 - 未启动 1 - 进行中 -1 - 失败 2 - 成功 |
| `scan_progress`       | `float`        | 扫描的进度，完成任务数/总任务数                                           |                                          |
| `scan_security_level` | `int`          | 扫描的安全等级结果，使用存在的最严重的漏洞等级作为结果，默认 0 表示无问题 |                                          |
| `scan_is_delete`      | `int`          | 扫描是否被删除                                                            | 0 - 未删除 1 - 已删除                    |
| `create_time`         | `datetime`     | 扫描创建时间                                                              |                                          |

### scan_period/定期扫描 {#scan-period-定期扫描}

| 属性名 | 数据类型 | 描述 | 默认值/可选值 |
| ------ | -------- | ---- | ------------- |
| `_id`  | `_ID`    |      |               |

### task/任务 {#task-任务}

每个 task 即是某次扫描中，利用某个 POC 对某个资产进行的一次渗透测试。

| 属性名         | 数据类型      | 描述                 | 默认值/可选值                            |
| -------------- | ------------- | -------------------- | ---------------------------------------- |
| `_id`          | `_ID`         |                      |                                          |
| `task_id`      | `UUID`        | 任务编号             |                                          |
| `scan_id`      | `UUID`        | 扫描编号             |                                          |
| `asset_id`     | `UUID`        |                      |                                          |
| `poc_id`       | `UUID`        |                      |                                          |
| `container_id` | `varchar(20)` | 该任务使用的容器编号 |                                          |
| `task_status`  | `int`         | 扫描当前状态         | 0 - 未启动 1 - 进行中 -1 - 失败 2 - 成功 |
| `retry_nums`   | `int`         | 该任务已经重试的次数 | 默认为 0                                 |
| `create_time`  | `datetime`    | 任务创建时间         |                                          |

### task_results/任务结果 {#task-results-任务结果}

| 属性名        | 数据类型    | 描述           | 默认值/可选值 |
| ------------- | ----------- | -------------- | ------------- |
| `_id`         | `_ID`       |                |               |
| `task_id`     | `UUID`      | 任务编号       |               |
| `task_log`    | `text`      | 任务的结果日志 |               |
| `vuln_ids`    | `JSONArray` | 发现的漏洞列表 |               |
| `create_time` | `datetime`  | 结果创建时间   |               |

## 设备管理 {#设备管理}

### user/用户 {#user-用户}

| 属性名          | 数据类型       | 描述     | 默认值/可选值 |
| --------------- | -------------- | -------- | ------------- |
| `_id`           | `_ID`          | 递增编号 |               |
| `user_id`       | `UUID`         | 用户编号 |               |
| `user_name`     | `varchar(100)` | 用户名   |               |
| `user_password` | `varchar(100)` | 用户密码 |               |

### user_session/用户登录信息 {#user-session-用户登录信息}

| 属性名        | 数据类型   | 描述     | 默认值/可选值 |
| ------------- | ---------- | -------- | ------------- |
| `_id`         | `_ID`      |          |               |
| `token`       | `text`     |          |               |
| `update_time` | `datetime` | 更新时间 |               |

### terminal/终端设备 {#terminal-终端设备}

| 属性名                  | 数据类型       | 描述             | 默认值/可选值 |
| ----------------------- | -------------- | ---------------- | ------------- |
| `_id`                   | `_ID`          |                  |               |
| `terminal_id`           | `UUID`         | 设备编号         |               |
| `terminal_name`         | `varchar(100)` | 设备名称         |               |
| `terminal_organization` | `varchar(100)` | 设备所属组织名   |               |
| `max_worker_num`        | `int`          | 最大工作节点数   |               |
| `max_retry_num`         | `int`          | 最大任务重试次数 |               |

## 统计报告 {#统计报告}

对于数据统计类型的结果，应该由定时器定期统计汇报；或者由前端触发统计生成。

### vulns_statistics_daily/按日的漏洞状况统计 {#vulns-statistics-daily-按日的漏洞状况统计}

| 属性名          | 数据类型 | 描述         | 默认值/可选值 |
| --------------- | -------- | ------------ | ------------- |
| `_id`           | `_ID`    |              |               |
| `date`          | `date`   | 日期         |               |
| `critical_nums` | `int`    | 严重漏洞数目 |               |
| `high_nums`     | `int`    | 严重漏洞数目 |               |
| `medium_nums`   | `int`    | 严重漏洞数目 |               |
| `low_nums`      | `int`    | 严重漏洞数目 |               |
